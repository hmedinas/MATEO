
var urlTemp = "";
var dataResult;
var dataResult_ = {
    "GetTableULDResult": {
        "CO_CIUD_DEST": "MXMEX ",
        "CO_CIUD_ORIG": "USLMS ",
        "CO_EMPR": "06",
        "CO_ENTI_LINE": "5X          ",
        "CO_TERM": "0001",
        "CT_ACTU_ULDS": "99",
        "CT_TOTA_ULDS": "1500",
        "DE_CIUD_DEST": "MEXICO CITY -- MEXIC",
        "DE_CIUD_ORIG": "LOUISVILLE -- UNITED",
        "DE_DESC_ULDS": "Recepcionado",
        "DE_ENTI_LINE": "",
        "FE_LLEG_ALMA": "25-03-2015",
        "FE_LLEG_VUEL": "25-03-20155",
        "LG_ENTI_LINE": "",
        "NU_MANI": "201500000001872",
        "NU_VUEL": "0320",
        "PC_ESTI_ULDS": "90",
        "TI_ENTI_LINE": "LIN",
        "lstBE_TCMANI_ULDS": "",
        "lstBE_TCMANI_ULDS_TEMP": [
          {
              "CAN_ULDS": 0,
              "CO_EMPR": "06",
              "CO_LINE": "",
              "CO_TERM": "0001",
              "DE_OBSE": "",
              "NU_MANI": "201500000001872",
              "NU_ULD": "1003",
              "NU_ULD_AMEX": ""
          },
          {
              "CAN_ULDS": 0,
              "CO_EMPR": "06",
              "CO_LINE": "",
              "CO_TERM": "0001",
              "DE_OBSE": "",
              "NU_MANI": "201500000001872",
              "NU_ULD": "1004",
              "NU_ULD_AMEX": ""
          },
          {
              "CAN_ULDS": 0,
              "CO_EMPR": "06",
              "CO_LINE": "",
              "CO_TERM": "0001",
              "DE_OBSE": "",
              "NU_MANI": "201500000001872",
              "NU_ULD": "1005",
              "NU_ULD_AMEX": ""
          },
          {
              "CAN_ULDS": 0,
              "CO_EMPR": "06",
              "CO_LINE": "",
              "CO_TERM": "0001",
              "DE_OBSE": "",
              "NU_MANI": "201500000001872",
              "NU_ULD": "1006",
              "NU_ULD_AMEX": ""
          },
          {
              "CAN_ULDS": 0,
              "CO_EMPR": "06",
              "CO_LINE": "",
              "CO_TERM": "0001",
              "DE_OBSE": "",
              "NU_MANI": "201500000001872",
              "NU_ULD": "1007",
              "NU_ULD_AMEX": ""
          },
          {
              "CAN_ULDS": 0,
              "CO_EMPR": "06",
              "CO_LINE": "",
              "CO_TERM": "0001",
              "DE_OBSE": "",
              "NU_MANI": "201500000001872",
              "NU_ULD": "2000",
              "NU_ULD_AMEX": ""
          },
          {
              "CAN_ULDS": 0,
              "CO_EMPR": "06",
              "CO_LINE": "",
              "CO_TERM": "0001",
              "DE_OBSE": "",
              "NU_MANI": "201500000001872",
              "NU_ULD": "2344",
              "NU_ULD_AMEX": ""
          },
          {
              "CAN_ULDS": 0,
              "CO_EMPR": "06",
              "CO_LINE": "",
              "CO_TERM": "0001",
              "DE_OBSE": "",
              "NU_MANI": "201500000001872",
              "NU_ULD": "3000",
              "NU_ULD_AMEX": ""
          }
        ],
        "lstBE_TDMANI_ULDS": [
          {
              "CO_EMPR": "06",
              "CO_GROU_ULD": "1000",
              "CO_TERM": "0001",
              "CO_USER_CREA": "",
              "CO_USER_MODI": "",
              "CT_ULD": "1",
              "DE_OBSE_0001": "",
              "DE_OBSE_0002": "",
              "FE_USER_DATE": "11-06-2015 12:32",
              "FE_USER_MODI": "",
              "HO_AERO_AMEX": "",
              "HO_ARRI": "",
              "MT_CARR": "",
              "NOM_TRANS": "HUGO MEDINA",
              "NU_ARRA": "H001",
              "NU_GUIA_MAGA": "",
              "NU_MANI": "201500000001872",
              "NU_PLACA": "DIAO882",
              "NU_SECU": "",
              "NU_ULD": "1003",
              "NU_ULD_AMEX": "",
              "OP_CARR": "",
              "ST_REGI": ""
          },
          {
              "CO_EMPR": "06",
              "CO_GROU_ULD": "1000",
              "CO_TERM": "0001",
              "CO_USER_CREA": "",
              "CO_USER_MODI": "",
              "CT_ULD": "1",
              "DE_OBSE_0001": "",
              "DE_OBSE_0002": "",
              "FE_USER_DATE": "11-06-2015 12:32",
              "FE_USER_MODI": "",
              "HO_AERO_AMEX": "",
              "HO_ARRI": "",
              "MT_CARR": "",
              "NOM_TRANS": "HUGO MEDINA",
              "NU_ARRA": "H001",
              "NU_GUIA_MAGA": "",
              "NU_MANI": "201500000001872",
              "NU_PLACA": "DIAO882",
              "NU_SECU": "",
              "NU_ULD": "1005",
              "NU_ULD_AMEX": "",
              "OP_CARR": "",
              "ST_REGI": ""
          },
          {
              "CO_EMPR": "06",
              "CO_GROU_ULD": "1000",
              "CO_TERM": "0001",
              "CO_USER_CREA": "",
              "CO_USER_MODI": "",
              "CT_ULD": "1",
              "DE_OBSE_0001": "",
              "DE_OBSE_0002": "",
              "FE_USER_DATE": "11-06-2015 16:56",
              "FE_USER_MODI": "",
              "HO_AERO_AMEX": "",
              "HO_ARRI": "",
              "MT_CARR": "",
              "NOM_TRANS": "PEPE",
              "NU_ARRA": "00001",
              "NU_GUIA_MAGA": "",
              "NU_MANI": "201500000001872",
              "NU_PLACA": "97846",
              "NU_SECU": "",
              "NU_ULD": "1007",
              "NU_ULD_AMEX": "",
              "OP_CARR": "",
              "ST_REGI": ""
          },
          {
              "CO_EMPR": "06",
              "CO_GROU_ULD": "1000",
              "CO_TERM": "0001",
              "CO_USER_CREA": "",
              "CO_USER_MODI": "",
              "CT_ULD": "1",
              "DE_OBSE_0001": "",
              "DE_OBSE_0002": "",
              "FE_USER_DATE": "11-06-2015 16:56",
              "FE_USER_MODI": "",
              "HO_AERO_AMEX": "",
              "HO_ARRI": "",
              "MT_CARR": "",
              "NOM_TRANS": "PEPE",
              "NU_ARRA": "00001",
              "NU_GUIA_MAGA": "",
              "NU_MANI": "201500000001872",
              "NU_PLACA": "97846",
              "NU_SECU": "",
              "NU_ULD": "1004",
              "NU_ULD_AMEX": "",
              "OP_CARR": "",
              "ST_REGI": ""
          },
          {
              "CO_EMPR": "06",
              "CO_GROU_ULD": "1000",
              "CO_TERM": "0001",
              "CO_USER_CREA": "",
              "CO_USER_MODI": "",
              "CT_ULD": "1",
              "DE_OBSE_0001": "",
              "DE_OBSE_0002": "",
              "FE_USER_DATE": "11-06-2015 16:56",
              "FE_USER_MODI": "",
              "HO_AERO_AMEX": "",
              "HO_ARRI": "",
              "MT_CARR": "",
              "NOM_TRANS": "PEPE",
              "NU_ARRA": "00001",
              "NU_GUIA_MAGA": "",
              "NU_MANI": "201500000001872",
              "NU_PLACA": "97846",
              "NU_SECU": "",
              "NU_ULD": "2344",
              "NU_ULD_AMEX": "",
              "OP_CARR": "",
              "ST_REGI": ""
          },
          {
              "CO_EMPR": "06",
              "CO_GROU_ULD": "1000",
              "CO_TERM": "0001",
              "CO_USER_CREA": "",
              "CO_USER_MODI": "",
              "CT_ULD": "1",
              "DE_OBSE_0001": "",
              "DE_OBSE_0002": "",
              "FE_USER_DATE": "11-06-2015 16:59",
              "FE_USER_MODI": "",
              "HO_AERO_AMEX": "",
              "HO_ARRI": "",
              "MT_CARR": "",
              "NOM_TRANS": "7OOO",
              "NU_ARRA": "0002",
              "NU_GUIA_MAGA": "",
              "NU_MANI": "201500000001872",
              "NU_PLACA": "LGIJ",
              "NU_SECU": "",
              "NU_ULD": "3000",
              "NU_ULD_AMEX": "",
              "OP_CARR": "",
              "ST_REGI": ""
          },
          {
              "CO_EMPR": "06",
              "CO_GROU_ULD": "1000",
              "CO_TERM": "0001",
              "CO_USER_CREA": "",
              "CO_USER_MODI": "",
              "CT_ULD": "1",
              "DE_OBSE_0001": "",
              "DE_OBSE_0002": "",
              "FE_USER_DATE": "11-06-2015 16:59",
              "FE_USER_MODI": "",
              "HO_AERO_AMEX": "",
              "HO_ARRI": "",
              "MT_CARR": "",
              "NOM_TRANS": "7OOO",
              "NU_ARRA": "0002",
              "NU_GUIA_MAGA": "",
              "NU_MANI": "201500000001872",
              "NU_PLACA": "LGIJ",
              "NU_SECU": "",
              "NU_ULD": "2000",
              "NU_ULD_AMEX": "",
              "OP_CARR": "",
              "ST_REGI": ""
          },
          {
              "CO_EMPR": "06",
              "CO_GROU_ULD": "1000",
              "CO_TERM": "0001",
              "CO_USER_CREA": "",
              "CO_USER_MODI": "",
              "CT_ULD": "1",
              "DE_OBSE_0001": "",
              "DE_OBSE_0002": "",
              "FE_USER_DATE": "11-06-2015 16:59",
              "FE_USER_MODI": "",
              "HO_AERO_AMEX": "",
              "HO_ARRI": "",
              "MT_CARR": "",
              "NOM_TRANS": "7OOO",
              "NU_ARRA": "0002",
              "NU_GUIA_MAGA": "",
              "NU_MANI": "201500000001872",
              "NU_PLACA": "LGIJ",
              "NU_SECU": "",
              "NU_ULD": "1006",
              "NU_ULD_AMEX": "",
              "OP_CARR": "",
              "ST_REGI": ""
          }
        ]
    }
};


/* declaracion de variables*/
//================================================
//Cargar el formulario
var $body = $('body');
//cursor1
var NU_VUEL = $("[data-mani='NU_VUEL']");
var LG_LINEA = $("[data-mani='LG_LINEA']");
var ST_VUEL = $("[data-mani='ST_VUEL']");
var FE_LLEG_VUEL = $("[data-mani='FE_LLEG_VUEL']");
var DE_ORIG = $("[data-mani='DE_ORIG']");
var NU_MANI = $("[data-mani='NU_MANI']");
var DE_DEST = $("[data-mani='DE_DEST']");
var PC_ESTI = $("[data-mani='PC_ESTI']");
var PC_ESTI_BARR = $(".baner-select");
var CT_ULDS_ACTU = $("[data-mani='CT_ULDS_ACTU']");
var CT_ULDS_FINA = $("[data-mani='CT_ULDS_FINA']");


var ULDPendient = {};
ULDPendient.ULD;
ULDPendient.Aero;
ULDPendient.Obse;
var Grilla1 = $("[data-ListaULD]");

var Toggle = $("[data-Toogle]");

//================================================

//==================  DATOS PARA EL JSON   =====================
var URL_SERVICE = "http://192.168.102.241/SERVICE/srvMATEO/Services/ServULDS.svc/";

function getUrlVars() {
    var vars = [], hash;
    var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
    for (var i = 0; i < hashes.length; i++) {
        hash = hashes[i].split('=');
        vars.push(hash[0]);
        vars[hash[0]] = hash[1];
    }
    return vars;
}
function LoadData() {
    ShowLoading();
    //alert("Cargando...");
    var bw = new Browser();
    if (bw.name == "chrome" || bw.name == 'firefox') {
        var vars = getUrlVars();
        if (vars.length == 1) {
            ShowMessaje("No existen registros a Consultar.")
            
            return;
        }
        var Header = $("[data-header]");
        Header.text("CONSULTA DE ULD's");
        var Metodo="GetTableULD?";
        $.getJSON(URL_SERVICE + Metodo + "CO_EMPR=" + vars[vars[0]] + "&CO_TERM=" + vars[vars[1]] + "&NU_MANI=" + vars[vars[2]], onSucces, onError);
      
    }
    else {
        ShowMessaje("Navegador de internet no compatible. Intente con chrome o firefox.");
    }
}
function ShowMessaje(Mensaje)
{
    hideLoading();
    $(".mensaje").css("display", "block");
    $("[data-mensaje]").text(Mensaje);
}
function onSucces(data) {
    dataResult = data;
    if (dataResult.GetTableULDResult.CO_TERM != null) {
        renderCursor1();
        renderCursor2();
        RenderCursor3();
    }
    else {
        ShowMessaje("No existe registros.");
        return;

    }
    hideLoading();
}
function onError() {
    hideLoading();
    alert("Error");
}
//==================  DATOS PARA EL JSON   =====================

function renderCursor1() {


    NU_VUEL.text(dataResult.GetTableULDResult.CO_ENTI_LINE + " - " + dataResult.GetTableULDResult.NU_VUEL);
    if (dataResult.GetTableULDResult.CO_ENTI_LINE.trim() == "CV")
        LG_LINEA.attr("src", "../Recursos/ULD_Recursos/Image/CV.png");
    if (dataResult.GetTableULDResult.CO_ENTI_LINE.trim() == "LA")
        LG_LINEA.attr("src", "../Recursos/ULD_Recursos/Image/Lan.png");

    ST_VUEL.text(dataResult.GetTableULDResult.DE_DESC_ULDS);
    FE_LLEG_VUEL.text(dataResult.GetTableULDResult.FE_LLEG_VUEL);
    DE_ORIG.text(dataResult.GetTableULDResult.DE_CIUD_ORIG);
    NU_MANI.text(dataResult.GetTableULDResult.NU_MANI);
    DE_DEST.text(dataResult.GetTableULDResult.DE_CIUD_DEST);
    PC_ESTI.text("Estimado " + dataResult.GetTableULDResult.PC_ESTI_ULDS + "%");
    PC_ESTI_BARR.width(dataResult.GetTableULDResult.PC_ESTI_ULDS + "%");
    CT_ULDS_ACTU.text("Actual :" + dataResult.GetTableULDResult.CT_ACTU_ULDS + " ULD's");
    CT_ULDS_FINA.text("Final :" + dataResult.GetTableULDResult.CT_TOTA_ULDS + " ULD's");
};
function renderCursor2() {
    for (i = 0; i < dataResult.GetTableULDResult.lstBE_TCMANI_ULDS_TEMP.length; i++) {
        ULDPendient.ULD = dataResult.GetTableULDResult.lstBE_TCMANI_ULDS_TEMP[i].NU_ULD;
        ULDPendient.Aero = dataResult.GetTableULDResult.lstBE_TCMANI_ULDS_TEMP[i].NU_ULD_AMEX;
        ULDPendient.Obse = dataResult.GetTableULDResult.lstBE_TCMANI_ULDS_TEMP[i].DE_OBSE;

        if (BuscarDatoTable(ULDPendient.ULD, 'Registros') == false) {
            if (i % 2 == 0) {
                PrintTemplateRow1(ULDPendient);
            }
            else {
                PrintTemplateRow2(ULDPendient);
            }
        }
    }
};
function BuscarDatoTable(strCadena, strIDdeTabla) {
    //seleccionamos la tabla en la que vamos a buscar
    var $objTabla = $('#' + strIDdeTabla + " tr");

    var Existe = false;
    $objTabla.each(function () {

        var Referencia = $(this).find("td").eq(0).html();
        if (Referencia.trim() == strCadena.trim())
            Existe= true;
    });
    return Existe;
  

};
//funcion que activa el template, lo hacemos reutilizable
function activateTemplate(id) {
    var t = document.querySelector(id);
    return document.importNode(t.content, true);
};
function PrintTemplateRow1(ULDPendient) {
    var clone = activateTemplate("#template--tr1");
    clone.querySelector("[data-uld]").innerHTML = ULDPendient.ULD;
    clone.querySelector("[data-aero]").innerHTML = ULDPendient.Aero;
    clone.querySelector("[data-obse]").innerHTML = ULDPendient.Obse;

    $(Grilla1).append(clone);
};
function PrintTemplateRow2(ULDPendient) {
    var clone = activateTemplate("#template--tr2");
    clone.querySelector("[data-uld]").innerHTML = ULDPendient.ULD;
    clone.querySelector("[data-aero]").innerHTML = ULDPendient.Aero;
    clone.querySelector("[data-obse]").innerHTML = ULDPendient.Obse;

    $(Grilla1).append(clone);
};

var ContPR=0;

function RenderCursor3() {

    var html;
    var i;
    var nodeAct;
    var nodeNext;
    var cont = 0;
    var HandCont = 0;
    var CursorTemp = {};
    if (ContPR > 0) {
        $(".panel_rigth_arratre").remove();
        $(".panel_rigth_space").remove();
        ContPR = 0;
    }
   
    for (i = 0; i < dataResult.GetTableULDResult.lstBE_TDMANI_ULDS.length; i++) {

        nodeAct = dataResult.GetTableULDResult.lstBE_TDMANI_ULDS[i].NU_ARRA;
        if (i + 1 > dataResult.GetTableULDResult.lstBE_TDMANI_ULDS.length - 1)
            nodeNext = "";
        else
            nodeNext = dataResult.GetTableULDResult.lstBE_TDMANI_ULDS[i + 1].NU_ARRA;


        //agregamos a un cursor temporal
        if (nodeAct == nodeNext) {

            CursorTemp[cont] = dataResult.GetTableULDResult.lstBE_TDMANI_ULDS[i];
            cont = cont + 1;
        } //reseteamos los cursors temporales
        else {
            CursorTemp[cont] = dataResult.GetTableULDResult.lstBE_TDMANI_ULDS[i];


            html = CrearHTML(CursorTemp, HandCont, cont);
            $(Toggle).append(html);

            HandCont = HandCont + 1;
            cont = 0;
            console.log("fin------------------");
        }

    }
    //modifico el stilo del Data-toogle si hay muchos registros
    if (i > 7) {
        $(Toggle).css({ 'height': '570px', 'overflow': 'auto' });
    }
    ContPR = 1;
};

function CrearHTML(CursorTemp, index, CantReg) {


    var v_NU_ARRAT = CursorTemp[0].NU_ARRA;
    var v_FE_ARRAT = CursorTemp[0].FE_USER_DATE;
    var v_NOM_TRAN = CursorTemp[0].NOM_TRANS;
    var v_NU_PLACA = CursorTemp[0].NU_PLACA;
    var v_NU_GUIA_MAGA = CursorTemp[0].NU_GUIA_MAGA;
    var v_ES_AERO = CursorTemp[0].ES_AERO;

    var New_Estilo="";
    if (v_ES_AERO == 'S')
        New_Estilo = " Table-Guias-AeroMex";
    

    var html = '<div class="panel_rigth_arratre" > ' +
                  '<div class="panel_rigth_arratre-header' + New_Estilo + '">' +
                      '<div class="panel_rigth_arratre-header--left">' +
                        v_NU_ARRAT +
                      '</div>' +
                      '<div class="panel_rigth_arratre-header--center">' +
                          v_FE_ARRAT +
                      '</div>' +
                      '<div class="panel_rigth_arratre-header--rigth">' +
                          '<img src="../Recursos/ULD_Recursos/Image/Math_32.png" width="18px" id="button_' + index + '" class="Button"  onclick="runEffectID(' + index + ');"/>' +
                      '</div>' +
                  '</div>' +
                  '<div id="effect_' + index + '" class="effect">' +
                      '<div class="panel_rigth_arratre-body">' +
                          '<table id="t1" cellspacing="0" class="panel_rigth_arratre-body--tabla">' +
                              '<tr>' +
                                  '<td rowspan="2">' +
                                      '<div class="iv-img-person">' +
                                          '<img src="../Recursos/ULD_Recursos/Image/user.png" width="60px" />' +
                                      '</div>' +
                                  '</td>' +
                                  '<td>' +
                                      '<a>Transportista: </a>' + v_NOM_TRAN +
                                  '</td>' +
                                  '<td>' +
                                      '<a>Placa : </a>' + v_NU_PLACA +
                                  '</td>' +
                              '</tr>' +
                              '<tr>' +
                                  '<td>' +
                                      '<a>Guias Gamma: </a>' + v_NU_GUIA_MAGA +
                                  '</td>' +
                                  '<td></td>' +
                              '</tr>' +
                          '</table>' +
                      '</div>' +
                      '<div class="panel_rigth_arratre-footer">' +
                          '<table id="t2" class="panel_rigth_arratre-body--tabla table_grid">' +
                              '<tr class="tr-gray">' +
                                  '<td>Nro ULDs</td>' +
                                  '<td>Observaciones</td>' +
                                  '<td>Estado ULD</td>' +
                              '</tr>' +
                                 printRow(CursorTemp, CantReg + 1) +
                            '</table>' +
                        '</div>' +
                    '</div>' +
                    '</div>' +
                    '<div class="panel_rigth_space">' +
                    '</div>';


    return html;
};
function printRow(Grilla, CantReg) {
    if (Grilla == null)
        return '';

    var Tabla = '';
    var datGrilla = {};
    datGrilla.NU_ULD = '';
    datGrilla.NU_ULD_AMEX = '';
    datGrilla.DE_OBSE_0001 = '';
    datGrilla.DE_STAD_ULDS = '';




    for (j = 0; j < CantReg; j++) {
        datGrilla.NU_ULD = Grilla[j].NU_ULD;
        datGrilla.NU_ULD_AMEX = Grilla[j].NU_ULD_AMEX;
        datGrilla.DE_OBSE_0001 = Grilla[j].DE_OBSE_0001;
        datGrilla.DE_STAD_ULDS = Grilla[j].DE_STAD_ULDS;
        if (j % 2 == 0) {
            Tabla = Tabla +
                    '<tr class="tr-1">' +
                       '<td>' + datGrilla.NU_ULD + '</td>' +
                       '<td>' + datGrilla.DE_OBSE_0001 + '</td>' +
                       '<td>' + datGrilla.DE_STAD_ULDS + '</td>' +
                   '</tr>';
        }
        else {
            Tabla = Tabla +
                   '<tr class="tr-2">' +
                      '<td>' + datGrilla.NU_ULD + '</td>' +
                      '<td>' + datGrilla.DE_OBSE_0001 + '</td>' +
                      '<td>' + datGrilla.DE_STAD_ULDS + '</td>' +
                  '</tr>';
        }
    }
    return Tabla;
};
ShowLoading();
function ShowLoading() {
    $("#Loading").css("display", "block");

};
function hideLoading() {
    var Loading = $("#Loading");
    Loading.hide();
};
var resTime = 7;
var myCurrentSecond = 59;
var intervalo = 4000;
function updateTablero() {
    LoadData();
    resTime = 4
    myCurrentSecond = 59;
};
function UpdateAuto() {
  
    myCurrentSecond -= 1;
    if (myCurrentSecond == 0 && resTime > 0) {
        resTime -= 1;
        myCurrentSecond = 59;
    }
    if (resTime == 0 && myCurrentSecond == 0) {
        //timmer
        LoadData();
        resTime=4
        myCurrentSecond = 59;
    }
    Update(resTime, myCurrentSecond);
   
    setTimeout('UpdateAuto()', 1000);


};
function Update(mi, ss) {

    if (mi <= 1 & ss < 60) {
        var msg = document.getElementById('divTimeText');
        msg.innerHTML = 'Se actulizara en.<br\>' + mi + ':' + ss;
        showTimeoutMessage()
      
    }
    else {
        closeTimeoutMessage();
    }
};
function showTimeoutMessage() {
    var msg = document.getElementById('update');
    if (msg != null)
        msg.style.visibility = 'visible';
};
function closeTimeoutMessage() {
    var msg = document.getElementById('update');
    var txtt = document.getElementById('divTimeText');
    if (txtt != null)
        txtt.innerHTML = '';

    if (msg != null)
        msg.style.visibility = 'hidden';

}

(function () {
    LoadData();
    UpdateAuto();
})();

